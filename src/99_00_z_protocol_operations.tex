%MACのkeyサイズを記号化する
%提案法のreceiveCHLOが未定義

%MACを
% mを鍵生成に入れる
%  NONCの改ざんも可能
% Encにはk_mac,T_s*のみを入れる。改ざんされてもikが不一致になるので、Client側では改ざんを検出できる
% SCRA、CIDMA、SATMAはkを共有するためのクエリをサーバは待たなければならないが、提案法はそれをまたなくて良い。

% \subsection{Handshake operations}
\noindent
\underline{$\scfgGen(sk_s)$:} \\
 $1.\ \ t_s \xleftarrow{\$} \Zset_{q}^{\ast}$ \\
 $2.\ \ T_s = g^{t_s}$ \\
 $3.\ \ \SCID = \Hash(T_s \| \expy)$ \\
 $4.\ \ str = \text{ QUIC server config signature }$ \\
 $5.\ \ \doc = str \| 0x00 \| \SCID \| T_s \| \expy$ \\
 $6.\ \ \sigma_s = \SIG.\Sign(sk_s, \doc)$ \\
 $7.\ \ \SCFG_{pub} = (\SCID, T_s, \expy, \sigma_s, \cert_s)$ \\
 $8.\ \ \return\ (\SCFG_{pub}, t_s)$ \\
\\
\underline{$\inchoateCHLO()$:} \\
 $1.\ \ \cid \xleftarrow{\$} \{0,1\}^{64} $ \\
 $2.\ \ \pInfo = (IP_c, IP_s, port_c, port_s)$ \\
 $3.\ \ \return\ (\pInfo, \cid)$ \\
\\
\underline{$\REJ(m, \SCFG_{pub})$:} \\
 $1.\ \ (\pInfo, \cid) = m$ \\
 $2.\ \ \STK = \makeSTK()$ \\
 $3.\ \ \pInfo = (IP_s, IP_c, port_s, port_c)$ \\
 $4.\ \ \return\ (\pInfo, \cid, \SCFG_{pub}, \STK)$ \\
\\
\underline{$\initialCHLO(m)$:} \\
 $1.\ \ (\pInfo, \cid, \SCFG_{pub}, \STK) = m$ \\
 $2.\ \ \pInfo = (IP_c, IP_s, port_c, port_s)$ \\
 $3.\ \ \checkSCFG(\SCFG_{pub})$ \\
 $4.\ \ t_c \xleftarrow{\$} \Zset_{q}^{\ast}$ \\
 $5.\ \ T_c = g^{t_c}$ \\
 $6.\ \ r \xleftarrow{\$} \{0,1\}^{160}$ \\
 $7.\ \ \NONC \leftarrow currentTime \| r$ \\
 $8.\ \ \return\ (\pInfo, \cid, \STK, \SCID, \NONC, T_c)$ \\
\\
\underline{$\SHLO(m, \ik, \sqn)$:} \\
 $1.\ \ (\pInfo, \cid, \STK, \SCID, \NONC, T_c) = m$ \\
 $2.\ \ (\ik_c, \ik_s, \iv_c, \iv_s) = \ik$ \\
 $3.\ \ t_s^{\prime} \xleftarrow{\$} \Zset_{q}^{\ast}$ \\
 $4.\ \ T_s^{\prime} = g^{t_s^{\prime}}$ \\
 $5.\ \ \STK = \makeSTK()$ \\
 $6.\ \ H = (\cid, \sqn)$ \\
 $7.\ \ \plaintext = \SCFG_{pub} \| T_s^{\prime} \| \STK $\\
 $8.\ \ c = \SE.\Enc(\ik_c, \iv_c \| \sqn, H, \plaintext)$ \\
 $9.\ \ \return\ (\pInfo, H, c)$ \\
\\
\underline{$\receiveSHLO(m, \ik)$:} \\
 $1.\ \ (\pInfo, H, c) = m$ \\
 $2.\ \ (\ik_c, \ik_s, \iv_c, \iv_s) = \ik$ \\
 $3.\ \ (\cid, \sqn) = H$ \\
 $4.\ \ \plaintext = \SE.\Dec(\ik_c, \iv_c \| \sqn, H, c)$ \\
 $5.\ \ \text{If }\plaintext = \perp$ \\
 $6.\ \ \quad \Lambda = \text{'reject' and abort}$ \\
 $7.\ \ \SCFG_{pub} \| T_s^{\prime} \| \STK  = \plaintext $ \\
 $8.\ \ \return\ T_s^{\prime}$ \\
\\
\underline{$\CHLO(\STK, \SCFG_{pub})$:} \\
 $1.\ \ \cid \xleftarrow{\$} \{0,1\}^{64}$ \\
 $2.\ \ r \xleftarrow{\$} \{0,1\}^{160}$ \\
 $3.\ \ \NONC \leftarrow currentTime \| r$ \\
 $4.\ \ t_c^{\ast} \xleftarrow{\$} \Zset_{q}^{\ast}$ \\
 $5.\ \ T_c^{\ast} = g^{t_c^{\ast}}$ \\
 $6.\ \ \pInfo = (IP_{src}, IP_{dst}, port_{src}, port_{dst})$ \\
 $7.\ \ \return\ (\pInfo, \cid, \STK, \SCID, \NONC, T_c^{\ast})$ \\
\\
\underline{$\makeSTK()$:} \\
 $1.\ \ \iv_{\STK} \xleftarrow{\$} \{0,1\}^{96}$ \\
 $2.\ \ \plaintext = IP_c \| currentTime$ \\
 $3.\ \ \STK \leftarrow \iv_{\STK} \| \SE.\Enc(k_{\STK}, len,\iv_{\STK},\plaintext)$
\\
 $4.\ \ \return\ \STK$ \\
\\
\underline{$\checkSCFG(\SCFG_{pub})$:} \\
 $1.\ \ (\SCID, T_s, \expy, \sigma_s, \cert_s) = \SCFG_{pub}$ \\
 $2.\ \ \text{If } \expy \leq currentTime$ \\
 $3.\ \ \quad \Lambda = \text{'reject' and abort}$ \\
 $4.\ \ pk_s = \getPK(cert_s)$ \\
 $5.\ \ \text{If } \SIG.\Vfy(pk_s, \sigma_s, \doc) = \perp$ \\
 $6.\ \ \quad \Lambda = \text{'reject' and abort}$ \\
\\
\underline{$\checkQuery(\STK, k_{\STK}, \NONC, IP_c)$:} \\
 $1.\ \ (\iv_{\STK}, c) = \STK$ \\
 $2.\ \ (IP_c^{\prime}, time_{\STK}) = \SE.\Dec(k_{\STK}, \iv_{\STK}, c)$ \\
 $3.\ \ (time_{\NONC}, r) = \NONC$ \\
 $4.\ \ \text{If } (IP_c^{\prime}, currentTime) = \perp$, or \\
 $5.\ \ \quad IP_c^{\prime} \neq IP_c$, or $time_{\STK} \leq time_{allowed}$\\
 $6.\ \ \quad r \in \strike$, or $time_{\NONC} \not\in \strike_{rng}$ \\
 $7.\ \ \quad \quad \Lambda = \text{'reject' and abort}$ \\
\\
% \subsection{Key operations}
% \noindent
% \underline{$\getKey_c(\shareInfo, m, \init)$:} \\
%  $1.\ \ (\NONC, \cid ,T_s, t_c) = \shareInfo$ \\
%  $2.\ \ pms = T_s^{t_c}$ \\
%  $3.\ \ \return\ \extractKey(pms, \NONC, \cid, m, 40, \init)$ \\
% \\
% \underline{$\getKey_s(\shareInfo, m, \init)$:} \\
%  $1.\ \ (\NONC, \cid ,T_c, t_s) = \shareInfo$ \\
%  $2.\ \ pms = T_c^{t_s}$ \\
%  $3.\ \ \return\ \extractKey(pms, \NONC, \cid, m, 40, \init)$ \\
% \\
% \underline{$\extractKey(pms, \NONC, \cid, m, \ell, \init)$:}\\
%  $1.\ \ ms = \PRF(pms, \NONC)$ \\
%  $2.\ \ \text{If } \init = 1$ \\
%  $3.\ \ \quad str = \text{ QUIC key expansion }$ \\
%  $4.\ \ \text{Else }$ \\
%  $5.\ \ \quad str = \text{ QUIC forward secure expansion }$ \\
%  $6.\ \ \info = str \| 0x00 \| \cid \| m \| \SCFG_{pub}$ \\
%  $7.\ \ \return\ \text{the first $\ell$ octets (i.e. bytes) of T = }$ \\
%  $\quad \quad \text{(T(1),T(2), ...), where for all $i \in \Nset$, $T(i) = $} $\\
%  $\quad \quad \text{$\PRF(ms, T(i-1) \| \info \| 0x0i)$ and $T(0) = \epsilon$} $\\
% \\
% \subsection{Packet operations}
% \noindent
% \underline{$\getIV(H, \kappa, P)$:} \\
%  $1.\ \ (k_c, k_s, \iv_c, \iv_s) = \kappa$ \\
%  $2.\ \ \text{If } P \in \Client$ \\
%  $3.\ \ \quad src = c, dst = s$ \\
%  $4.\ \ \text{Else if} P \in \Server$ \\
%  $5.\ \ \quad src = s, dst = c$ \\
%  $6.\ \ (\cid, \sqn) = H$ \\
%  $7.\ \ \return\ (\iv_{dst}, \sqn)$ \\
% \\
% \underline{$\pak(\kappa, \sqn, m)$:} \\
%  $1.\ \ (k_c, k_s, \iv_c, \iv_s) = \kappa$ \\
%  $2.\ \ \text{If } P \in \Client$ \\
%  $3.\ \ \quad src = c, dst = s$ \\
%  $4.\ \ \text{Else if } P \in \Server$ \\
%  $5.\ \ \quad src = s, dst = c$ \\
%  $6.\ \ \pInfo = (IP_{src}, IP_{dst}, port_{src}, port_{dst})$ \\
%  $7.\ \ H = (\cid, \sqn)$ \\
%  $8.\ \ \iv = \getIV(H, \kappa)$ \\
%  $9.\ \ \return\ (\pInfo, \SE.\Enc(k_{dst}, \iv, H, m) )$ \\
% \\
% \underline{$\processPacket(\kappa, p_1,...,p_v)$:} \\
%  $1.\ \ (k_c, k_s, \iv_c, \iv_s) = \kappa$ \\
%  $2.\ \ \text{If } P \in \Client$ \\
%  $3.\ \ \quad src = c, dst = s$ \\
%  $4.\ \ \text{Else if} P \in \Server$ \\
%  $5.\ \ \quad src = s, dst = c$ \\
%  $6.\ \ \text{for each } \gamma \in [v]$ \\
%  $7.\ \ \quad (H_{\gamma}, c_{\gamma}) = p_{\gamma}$ \\
%  $8.\ \ \quad \iv_{\gamma} = \getIV(H_{\gamma}, \kappa)$ \\
%  $9.\ \ \quad m_{\gamma} = \SE.\Dec(k_{src}, \iv_{\gamma}, H_{\gamma}, c_{\gamma})$ \\